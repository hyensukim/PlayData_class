# 5. 스프링 디스커버리 유레카 서버

스프링 클라우드에서 제공하는 Eureka는 마이크로서비스 아키텍처에서 서비스의 등록, 발견, 및 관리를 위한 서비스 [디스커버리 서버](https://github.com/hyensukim/PlayData_class/blob/main/class/%EC%96%B8%EC%96%B4%20%EC%84%A4%EB%AA%85/%EB%94%94%EC%8A%A4%EC%BB%A4%EB%B2%84%EB%A6%AC.md "설명")이다. 이를 통해 마이크로서비스 간의 통신이 효율적으로 이뤄질 수 있다.

### 우선 설명하기에 앞서, Spring-cloud Eureka란 무엇일까?

스프링 클라우드에서 제공한 API를 참고하여 각 기업마다 구현한 코드로써, Open source의 이점을 활용하기 위해 Spring Cloud에 기부한 구현 코드이다.

그 중 하나가 Spring-cloud Eureka이다.

Eureka는 2가지로 분류되는데, Eureka Server와 Eureka Discovery Client로 구분된다.

- Eureka Server : 디스커버리 서버로서, 로드 밸런싱과 헬스 체크 기능을 한다.
- Eureka Discovery Client : 유레카 서버로 부터 관리될 마이크로서비스들을 의미한다.

### 디스커버리 서버가 필요한 이유?

![img]()

게이트웨이 서버로만 사용할 경우, 로드 밸런싱이나 헬스 체크까지 하는데 어려움이 있어, 이를 할당한 디스커버리 서버로 로드 밸런싱 및 헬스 체크 기능을 수행하도록 한다.

## 🎇 Spring cloud Eureka

### 주요 특징 :

- 서비스 등록(Service Registration) : 마이크로서비스 시작 시 Eureka 서버에 자신의 위치 정보를 등록한다. 이를 통해 다른 서비스나 클라이언트가 해당 서비스를 찾을 수 있다.
- 서비스 감지(Service Discovery) : Eureka 클라이언트 라이브러리를 사용하여, 서비스를 찾고 해당 서비스의 메타데이터를 가져올 수 있다. 이를 통해 동적으로 서비스의 위치 파악이 가능하다.
- 서비스 상태 감시(Health Monitoring) : Eureka는 주기적으로 등록된 서비스의 상태를 확인한다. 이를 통해 장애가 발생한 서비스를 감지하고 다른 서비스로 요청을 라우팅할 수 있다.
- 동적 서비스 변경(Dynamic Service Changes) : 새로운 서비스 인스턴스가 추가되거나 기존의 인스턴스가 제거되어도 Eureka는 이를 감지하고 서비스 목록을 업데이트한다.
- 클라이언트 사이드 로드 밸런싱(Client-Side Load Balancing) : 유레카 클라이언트 라이브러리는 여러 인스턴스 중 하나를 선택하여 서비스로 요청을 보내는데, 이를 통해 부하를 분산한다.


### 작동 원리 :

1. Eureka 서버 구동 : 마이크로서비스에서 사용할 Eureka 서버를 실행. 이는 서비스 디스커버리의 중심 역할을 한다.
2. 서비스 등록 : 마이크로서비스가 시작될 때, 해당 서비스는 Eureka 서버에 자신의 정보를 등록한다. 이 정보에는 서비스의 이름, IP 주소, 포트 번호 등의 정보가 포함된다.
3. 서비스 감지 : 다른 마이크로서비스나 클라이언트가 특정 서비스를 호출하기 위해서는 Eureka 클라이언트 라이브러리를 사용하여 Eureka 서버에서 해당 서비스의 인스턴스를 찾아야 한다.
4. 서비스 사용 : 클라이언트는 Eureka로부터 받은 서비스 인스턴스 목록 중 하나를 선택하여 요청을 보낸다. 이때, 클라이언트 사이드 로드 밸런싱을 통해 부하가 고르게 분산된다.
5. 서비스 상태 감시 : Eureka 서버는 주기적으로 등록된 서비스의 상태를 확인한다. 만약 서비스가 응답하지 않는다면 해당 인스턴스를 다른 인스턴스로 대체할 수 있다.
6. 동적 서비스 변경 : 새로운 서비스 인스턴스가 추가되거나 기존 인스턴스가 제거되면, Eureka는 이를 감지하고 서비스 목록을 업데이트한다.


### Eureka 서버 설정 :

```
server : 
	port : 8761
eureka: 
	client:
		register-with-eureka: false
		fetch-registry: false

```

위 설정은 Eureka 서버를 8761 포트로 실행하며, 서비스 등록 및 서비스 목록 조회를 위한 설정이다.

`register-with-eureka`, `fetch-registry` 를 false로 설정하여 해당 서버는 자신을 등록하지 않고, 등록된 서비스 목록을 가져오지 않도록 설정했다.


### 요약 :

Spring cloud Eureka는 서비스 디스커버리를 쉽게 구현할 수 있도록 해주는 라이브러리이다. 서비스 등록, 감지, 상태 모니터링 등을 통해 마이크로서비스 간의 효율적인 통신을 가능하도록 해준다.


### 실습하기

프로젝트 생성 시 디스커버리 유레카 서버를 추가해준다.

![유레카 실습1]()

![유레카 실습2](https://file+.vscode-resource.vscode-cdn.net/c%3A/PlayData/phase02/class/)

![유레카 실습3](https://file+.vscode-resource.vscode-cdn.net/c%3A/PlayData/phase02/class/)


### Eureka 서버에 서비스 등록하고 확인하기

유레카 서버에 등록할 서비스는 Eureka Discovery Client 의존성을 추가해줘야 한다.

![유레카 클라이언트 실습1]()


생성된 프로젝트 ServiceApplication 클래스에 @EnableDiscoveryClient 어노테이션을 추가해준다.

![유레카 클라이언트 실습2]()

위 어노테이션이 추가돼야 유레카 서버에서 클라이언트로 인식되며 통신이 가능해진다.


application.yml 파일에 마이크로서비스 포트번호와 마이크로서비스 명칭을 추가해준다.

![유레카 클라이언트 실습3](https://file+.vscode-resource.vscode-cdn.net/c%3A/PlayData/phase02/class/)


클라이언트를 유레카 서버에 등록해준다.

![유레카 서버 클라이언트 추가]()

- 등록 전 유레카 대시보드

![유레카 대시보드1](https://file+.vscode-resource.vscode-cdn.net/c%3A/PlayData/phase02/class/)

- 등록 후 유레카 대시보드

![유레카 대시보드2](https://file+.vscode-resource.vscode-cdn.net/c%3A/PlayData/phase02/class/)


### 동일 프로젝트로 서버 2개 이상 실행시키기

실제 빌드 파일을 2개 이상 실행시켜도 되지만, 하나의 인텔리제이에서 여러 개의 서비스 인스턴스를 실행 해보자.

![서비스 추가1]()

먼저 위처럼 Edit Configuration으로 이동한다.

![서비스 추가2](https://file+.vscode-resource.vscode-cdn.net/c%3A/PlayData/phase02/class/)

위처럼 왼쪽에서 3번째 복사 버튼을 눌러준 뒤 apply 버튼을 통해 적용해준다.

복사 후 실행 탭을 다시 보면 이제 2개의 선택지가 있는것을 확인할 수 있다.

위의 복사된 인스턴스를 추가로 실행 시키면,


위처럼 포트 충돌로 인해 실행이 되지 않는다.

이는 본래 인스턴스에서 8003번 포트를 사용 중이기 때문이다.

이를 해결하기 위해서는

1. 서버 실행 단계에서 포트값을 새롭게 지정한다.
2. 각 서버 실행 시마다 랜덤포트를 실행하도록 한다.

라는 해결책이 있다.


우선, 1번 부터 확인해보면

- application.yml 파일에서 port 번호 수정.
- Edit Configuration - add VM Options 에서 추가.

`-Dserver.port=포트번호`

위에서 -D는 detach 모드를 의미하며, 콘솔창을 숨기고 애플리케이션을 가동한다는 의미이다.

이는 인텔리제이 콘솔창이 하나이기 때문에, 두 개 이상을 하나의 인텔리제이에서 기동 시 콘솔창을 숨겨줘야 한다.

각 인스턴스마다 포트번호를 바꾸는 것은 의미가 없다.(인스턴스 갯수가 커질수록 이를 수동으로 별도 지정하는 것은 오류가 날 확률이 높아진다.)


결국, 2번 방법으로 포트를 추가해준다.
