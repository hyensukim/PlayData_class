# ğŸ† MSA ê°œë³„ ì„œë¹„ìŠ¤ê°„ í†µì‹ 

MSA ê°œë³„ ì„œë¹„ìŠ¤ê°„ í†µì‹ í•˜ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œ,

- feign
- resttemplate

ì´ ìˆë‹¤.

ì´ ì¤‘ feign clientë¥¼ ì´ìš©í•œ ê°œë³„ ì„œë¹„ìŠ¤ê°„ì˜ í†µì‹ ì„ ì‹¤ìŠµ í•´ë³´ì.

## ğŸ‡ Feign í´ë¼ì´ì–¸íŠ¸

`Feign Client`  : ì™¸ë¶€ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë ¤ëŠ” ì„œë²„.

`DataBase` : í•„ìš”í•œ ë°ì´í„°ê°€ ìˆëŠ” ì„œë²„.

##### ì„¸íŒ…

í˜„ì¬ gateway-server, discovery-serverëŠ” ì‹¤í–‰ ì¤‘ì´ë‹¤.

ì„¸íŒ… ìˆœì„œëŠ” apigateway ì„œë²„ì— ê° ì„œë¹„ìŠ¤ ì„œë²„ë¥¼ ë“±ë¡í–ˆë‹¤ëŠ” ê°€ì • í•˜ì— ì§„í–‰.

Feign Client = 'item-service'

DataBase = 'order-service'

ì•„ì´í…œ ë³„ë¡œ ì£¼ë¬¸ë‚´ì—­ì„ ì¡°íšŒ


##### ì‹¤ìŠµ ì‹œì‘

DataBaseì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ì¿¼ë¦¬ë©”ì„œë“œë¥¼ ì •ì˜í•´ì¤€ë‹¤.

###### OrderRepository

```
Optional<List<Order>> findOrderByProductIdOrderByIdDesc(String productId);
```

jpa repositoryë¥¼ ì‚¬ìš©í•˜ì—¬ ëª©ë¡ ì¡°íšŒë¥¼ ìœ„í•œ serviceë¥¼ ì •ì˜í•œë‹¤.

###### OrderService

```
public Optional<List<Order>> getOrderListByProductId(String productId){
        return orderRepository.findOrderByProductIdOrderByIdDesc(productId);
    }
```

###### OrderController

```
@GetMapping("orders/items/{productId}")
    public ResponseEntity<?> getOrdersFeignByProductId(@PathVariable String productId){
        List<Order> orders = orderService.getOrderListByProductId(productId)
                .orElseThrow(() -> new RuntimeException("ì£¼ë¬¸ëœ ìƒí’ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."));

        return ResponseEntity.status(200).body(orders);
    }
```

ìœ„ì˜ ì½”ë“œë“¤ì€ ìƒí’ˆë²ˆí˜¸ë¡œ ì¡°íšŒëœ ì£¼ë¬¸ë‚´ì—­ ëª©ë¡ì„ **"orders/items/{productId}"** ë¼ëŠ” urlì„ í†µí•´ `feign client` ì¸¡ìœ¼ë¡œ ì „ë‹¬í•˜ê¸° ìœ„í•œ ì½”ë“œì´ë‹¤.


ì´ì œ `feign client` ì¸¡ ì½”ë“œë¥¼ ì¶”ê°€í•´ë³´ì.

ìš°ì„ , ItemServiceApplication ì— @EnableFignClientsë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.

###### ItemServiceApplication

```
@EnableFeignClients
public class ItemServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ItemServiceApplication.class, args);
    }

}
```



ê·¸ ë‹¤ìŒ, feignì„ í•˜ê¸° ìœ„í•´ feign clinet ë¼ëŠ” íŒ¨í‚¤ì§€ë¥¼ ìƒì„±í•œ ë’¤ OrderFeignClient ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¶”ê°€í•´ì¤€ ë’¤, OrderFeignClient ë‚´ feignì„ ìœ„í•œ ë©”ì„œë“œë¥¼ ì •ì˜í•´ì¤€ë‹¤.

![1698901610779](image/2023.11.1~2/1698901610779.png)


###### OrderFeignClient

```
import com.playdata.itemservice.domain.Order;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

import java.util.List;

@FeignClient(name="ORDER-SERVICE", path="order-service")
public interface OrderFeignClient {

    @GetMapping("orders/items/{productId}")
    List<Order> getOrdersFeignByProductId(@PathVariable String productId);
}

```


- @FeignClient() : ì„œë²„ ê°„ì˜ í†µì‹ ì„ ìœ„í•´ "ë””ìŠ¤ì»¤ë²„ë¦¬ ì„œë²„" ë‚´ ì •ì˜ëœ ì„œë¹„ìŠ¤ëª…ê³¼ ê²½ë¡œë¡œ ì„¤ì •í•´ì¤€ë‹¤.
- @GetMapping() : í•´ë‹¹ ì„œë²„ ë‚´ ë°ì´í„° ëª©ë¡ì„ ë°˜í™˜í•˜ëŠ” Controllerì— ì •ì˜ëœ URLë¥¼ ëª…ì‹œí•´ì¤€ë‹¤.

feign ìš”ì²­ì„ ìœ„í•´ ë©”ì„œë“œë¥¼ ì•„ë˜ì˜ êµ¬ì¡°ë¡œ ì‘ì„±í•´ì¤˜ì•¼ í•œë‹¤.

```
@FeignClient(name = "eurekaì— ë“±ë¡í•œ ì„œë¹„ìŠ¤ëª…")
public interface ì¸í„°í˜ì´ìŠ¤ëª… {
    @GetMapping("/ì—”ë“œí¬ì¸íŠ¸íŒ¨í„´/{pathvariableì´ ìˆë‹¤ë©´...}")
    ë¦¬í„´ìë£Œí˜• ë©”ì„œë“œëª…(@PathVariable("pathvariableëª…") ìë£Œí˜• ë³€ìˆ˜ëª…);
}
```



feigní•˜ì—¬ ê°€ì ¸ì˜¨ Order ëª©ë¡ì„ ë°›ì„ List \<Order> ë¥¼ ê°–ëŠ” ResponseFeignItemDtoë¥¼ ì •ì˜í•œë‹¤.


###### ResponseFeignItemDto

```
import com.playdata.itemservice.domain.Item;
import com.playdata.itemservice.domain.Order;
import lombok.*;

import java.util.List;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ResponseFeignItemDto {

    private String productId;
    private String productName;
    private Long stock;
    private Long pricePerItem;
    private List<Order> orderList;

    public ResponseFeignItemDto(Item item){
        productId = item.getProductId();
        productName = item.getProductName();
        stock = item.getStock();
        pricePerItem = item.getPricePerItem();
    }
}
```


ì¶”ê°€ë¡œ, Order í´ë˜ìŠ¤ëŠ” item-service ì„œë²„ ë‚´ ì •ì˜ë˜ì§€ ì•Šì€ ê°ì²´ì´ë¯€ë¡œ, Orderë¥¼ ìƒì„±í•´ì¤€ë‹¤.

Order í´ë˜ìŠ¤ëŠ” order-serviceì—ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ê¸° ìœ„í•œ ëª©ì ì´ë¯€ë¡œ order-serviceì—ì„œ ê°€ì ¸ì˜¬

Order í…Œì´ë¸” ë‚´ ì»¬ëŸ¼ë“¤ì„ í•„ë“œë¡œ ì •ì˜í•œë‹¤.

###### Order - item-service

```
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;

import java.time.LocalDateTime;

@Getter @Setter @ToString
public class Order {
    private Long id;

    private String orderId;

    private Long count;

    private LocalDateTime createdAt;

    private String userId;

    private String productId;
}
```


feign ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ Serviceì— ê¸°ëŠ¥ì„ ì¶”ê°€í•´ì¤€ë‹¤.

###### ItemService

```
public ResponseFeignItemDto findItemOrderList(String productId){

        Item item = itemRepository.findByProductId(productId);
        ResponseFeignItemDto dto = new ResponseFeignItemDto(item);
        dto.setOrderList(feignClient.getOrdersFeignByProductId(productId));
        return dto;

    }
```


ì´í›„ Controllerì—ì„œ í•´ë‹¹ Serviceë¡œ ë°˜í™˜í•œ ResponseFeignItemDto ê°ì²´ë¥¼ ë°˜í™˜í•˜ë„ë¡ êµ¬í˜„í•œë‹¤.

###### ItemController

```
@GetMapping("items/{productId}/orders")
    public ResponseEntity<?> findOrderListByProductId(@PathVariable String productId){
        ResponseFeignItemDto item = itemService.findItemOrderList(productId);
        return ResponseEntity.status(200).body(item);
    }
```


í¬ìŠ¤íŠ¸ë§¨ì—ì„œ ìš”ì²­ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì


ì•„ë˜ì™€ ê°™ì´ item-serviceì— GET ìš”ì²­ì„ ë³´ëƒˆë‹¤.

![1698903173213](image/2023.11.1~2/1698903173213.png)


ì •ìƒ ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![1698903029172](image/2023.11.1~2/1698903029172.png)


## ğŸ‡ ê²°ë¡ 

Fein Client ë¥¼ ì‚¬ìš©í•˜ì—¬ MSA ê°œë³„ ì„œë¹„ìŠ¤ ê°„ì— í†µì‹ ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë³´ì•˜ë‹¤.

MSA êµ¬ì¡°ì—ì„œëŠ” Serverê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ ë‚˜ëˆ ì ¸ ìˆê¸° ë•Œë¬¸ì— JOINì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

ë”°ë¼ì„œ, ì„œë²„ ê°„ í†µì‹ ì„ í†µí•´ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ì•„ì•¼ í•˜ê¸° ë•Œë¬¸ì— Feign Clientë¥¼ ì‚¬ìš©í•œ ê²ƒì´ë‹¤.
